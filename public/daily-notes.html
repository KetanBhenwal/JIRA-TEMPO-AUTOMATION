<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Notes AI Logger</title>
<style>
 body { font-family: system-ui, Arial, sans-serif; background:#f5f7fa; margin:0; padding:20px; max-width:1200px; }
 .navigation { background:#fff; padding:15px 25px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1);} 
 .navigation a { color:#0052cc; text-decoration:none; margin-right:20px; font-weight:500; }
 .navigation a:hover { text-decoration:underline; }
 .container { background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
 h1 { color:#0052cc; margin-top:0; }
 textarea { width:100%; min-height:180px; resize:vertical; padding:12px; border:1px solid #dfe1e6; border-radius:6px; font-size:14px; line-height:1.5; }
 input[type=date] { padding:8px; border:1px solid #dfe1e6; border-radius:6px; }
 .btn { background:#0052cc; color:#fff; padding:10px 18px; border:none; border-radius:4px; cursor:pointer; font-size:14px; }
 .btn.secondary { background:#6b778c; }
 .btn:disabled { background:#b3cdfb; cursor:not-allowed; }
 .row { display:flex; gap:12px; flex-wrap:wrap; }
 .status { margin-top:15px; font-size:14px; }
 .error { background:#ffebe6; color:#ae2a19; padding:12px; border-left:4px solid #ff5630; border-radius:4px; }
 .success { background:#e3fcef; color:#006644; padding:12px; border-left:4px solid #36b37e; border-radius:4px; }
 .blocks { margin-top:25px; }
 table { width:100%; border-collapse:collapse; margin-top:10px; }
 th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:13px; }
 th { background:#f6f8fa; }
 code { background:#f4f5f7; padding:2px 4px; border-radius:3px; font-size:12px; }
 .pill { display:inline-block; padding:2px 6px; border-radius:12px; font-size:11px; background:#f4f5f7; color:#42526e; }
 .pill.meeting { background:#e3fcef; color:#006644; }
 .pill.development { background:#deebff; color:#0747a6; }
 .pill.error { background:#ffebe6; color:#ae2a19; }
 .inline { display:inline-flex; align-items:center; gap:6px; }
 pre.json { background:#091e420f; padding:12px; border-radius:6px; font-size:12px; overflow:auto; max-height:300px; }
 .flex-between { display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>
  <!-- navigation injected by nav.js -->
  <div class="container">
    <div class="flex-between">
      <h1>Daily Notes → AI Time Blocks</h1>
      <div style="font-size:12px; color:#555;">Model: <span id="modelName">(configured)</span></div>
    </div>
    <p>Paste or type your raw daily notes. The AI will parse them into structured time blocks and attempt to log them to Tempo. Meeting blocks use the default meeting issue if no issue key is found.</p>
    <div class="row">
      <div>
        <label for="date">Date</label>
        <input type="date" id="date" />
      </div>
    </div>
    <label for="notes">Daily Notes</label>
    <textarea id="notes" placeholder="e.g. Standup 15m, worked on CON22-4278 API refactor ~3h, debugging login issue CON22-2582 1h ..."></textarea>
    <div class="row">
      <button id="parseBtn" class="btn">Parse & Log</button>
      <button id="dryRunBtn" class="btn secondary">Parse Only (Dry Run)</button>
      <button id="clearBtn" class="btn secondary">Clear</button>
    </div>
    <div id="status" class="status"></div>
    <div id="warnings"></div>
    <div class="blocks" id="blocksContainer" style="display:none;">
      <h2>Parsed Blocks</h2>
      <table id="blocksTable">
        <thead>
          <tr>
            <th>#</th><th>Start</th><th>End</th><th>Minutes</th><th>Type</th><th>Issue</th><th>Description</th><th>Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3>Raw Parsed JSON</h3>
      <pre class="json" id="rawJson"></pre>
    </div>
  </div>
<script src="nav.js"></script>
<script>
function fmt(t){return t==null?'':t}
const dateInput = document.getElementById('date');
const notesEl = document.getElementById('notes');
const parseBtn = document.getElementById('parseBtn');
const dryRunBtn = document.getElementById('dryRunBtn');
const clearBtn = document.getElementById('clearBtn');
const statusDiv = document.getElementById('status');
const warningsDiv = document.getElementById('warnings');
const blocksContainer = document.getElementById('blocksContainer');
const blocksTableBody = document.querySelector('#blocksTable tbody');
const rawJsonPre = document.getElementById('rawJson');

dateInput.value = new Date().toISOString().split('T')[0];

async function submit(dryRun){
  statusDiv.innerHTML = '⏳ Parsing with AI...';
  statusDiv.className = 'status';
  warningsDiv.innerHTML='';
  blocksContainer.style.display='none';
  blocksTableBody.innerHTML='';
  rawJsonPre.textContent='';
  parseBtn.disabled = dryRunBtn.disabled = true;
  try {
    const payload = { date: dateInput.value, notes: notesEl.value };
    const res = await fetch('/api/ai/log-daily-notes' + (dryRun?'?dryRun=1':''), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok){
      const err = await res.json().catch(()=>({error:'Unknown error'}));
      throw new Error(err.error + (err.details?(' - '+err.details):''));
    }
    const data = await res.json();
    const { parsed, logResult } = data;
    if (parsed.warnings && parsed.warnings.length){
      warningsDiv.innerHTML = '<div class="error">'+parsed.warnings.map(w=>`⚠️ ${w}`).join('<br>')+'</div>';
    }
    rawJsonPre.textContent = JSON.stringify(parsed, null, 2);
    blocksContainer.style.display='block';
    (logResult.results||[]).forEach((r,i)=>{
      const tr = document.createElement('tr');
      const block = r.block || {}; 
      tr.innerHTML = `<td>${i+1}</td><td>${fmt(block.start||'')}</td><td>${fmt(block.end||'')}</td><td>${fmt(block.minutes)}</td><td><span class="pill ${block.type||''}">${block.type||''}</span></td><td>${fmt(block.issueKey||'')}</td><td>${fmt(block.description||'')}</td><td>${r.status}${r.worklogId?` <code>${r.worklogId}</code>`:''}${r.reason?` (${r.reason})`:''}${r.error?` <span class='pill error'>${r.error}</span>`:''}</td>`;
      blocksTableBody.appendChild(tr);
    });
    const loggedCount = (logResult.results||[]).filter(r=>r.status==='logged').length;
    statusDiv.className = 'status success';
    statusDiv.innerHTML = `✅ Parsed ${parsed.blocks.length} blocks. Logged ${loggedCount}. Total Minutes: ${parsed.totalMinutes}`;
  } catch(e){
    statusDiv.className='status error';
    statusDiv.innerHTML = '❌ '+e.message;
  } finally {
    parseBtn.disabled = dryRunBtn.disabled = false;
  }
}

parseBtn.addEventListener('click', ()=> submit(false));
dryRunBtn.addEventListener('click', ()=> submit(true));
clearBtn.addEventListener('click', ()=> { notesEl.value=''; statusDiv.innerHTML=''; blocksContainer.style.display='none'; warningsDiv.innerHTML=''; });
</script>
</body>
</html>
